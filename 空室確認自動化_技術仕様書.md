# 空室確認自動化 技術仕様書

別プロジェクトに移植する際のリファレンスドキュメント。

---

## 1. システム概要

ユーザーがWebアプリ上で「空室確認」「内見希望」「申込希望」ボタンを押すと、
**Pythonワーカーが物件掲載サイトにアクセスし、募集中/終了を自動判定**し、
結果をLINEメッセージで即座にユーザーに通知する仕組み。

### アーキテクチャ

```
ユーザー (LINE + Webアプリ)
    │
    ▼
[POST /api/cv] ──→ DBにリクエスト保存 (status=pending)
    │                + LINE「確認中です」メッセージ送信
    │
    ▼
[Python Worker] ──→ 5〜15秒ごとにAPIポーリング
    │                GET /api/cv-check/pending
    │                ↓ 物件サイトにPlaywrightでアクセス
    │                ↓ ページテキストから募集状況を判定
    │                POST /api/cv-check/result
    │
    ▼
[結果API] ──→ DB更新 + LINE自動メッセージ送信
    │          found: 「募集中です！」+ 電話予約CTA
    │          ended: 「募集終了しています」
    │
    ▼
[CRM管理画面] ──→ スタッフが "found" 物件を分類
    │               先行申込 / 先行契約 / 内見可
    │               POST /api/cv-check/classify
    │
    ▼
[分類結果LINE送信] ──→ 分類に応じた詳細メッセージ
```

---

## 2. ファイル構成

| ファイル | 役割 |
|---------|------|
| `scraping/cv_check_worker.py` | Pythonワーカー本体（ポーリング＋物件確認） |
| `scraping/start_cv_worker.bat` | ワーカー起動バッチ |
| `src/app/api/cv/route.ts` | CV送信エンドポイント（ユーザーがボタン押下時） |
| `src/app/api/cv-check/pending/route.ts` | ワーカーが未処理リクエストを取得 |
| `src/app/api/cv-check/result/route.ts` | ワーカーが確認結果を送信 |
| `src/app/api/cv-check/classify/route.ts` | スタッフが物件を分類 |
| `src/app/api/cv-check/list/route.ts` | CRM一覧取得 |
| `src/app/api/cv-check/test/route.ts` | テスト用エンドポイント |
| `src/lib/server/cvCheckRepository.ts` | DB操作（CRUD全般） |
| `src/lib/server/cvCheckMessages.ts` | LINEメッセージテンプレート |
| `src/app/crm/(protected)/cv-check/page.tsx` | CRM管理画面（ステータス一覧・分類ボタン） |
| `src/app/crm/(protected)/cv-check/test/page.tsx` | テスト画面 |

---

## 3. データベース設計

### テーブル: `cv_check_requests`

```sql
create table cv_check_requests (
  id             bigserial primary key,
  property_id    bigint not null,          -- 物件ID
  property_name  text not null,            -- 物件名（表示用）
  detail_url     text not null default '', -- 物件掲載ページURL
  source         text not null default '', -- 掲載元 (itanji, es_square, ierabu_bb)
  cv_type        text not null,            -- availability / viewing / application
  line_user_id   text not null,            -- LINEユーザーID
  contact_id     bigint,                   -- CRM連絡先ID
  status         text not null default 'pending',
  check_result   jsonb not null default '{}',  -- ワーカーの判定結果
  classification text,                     -- スタッフ分類結果
  classified_by  text,                     -- staff / auto
  is_test        boolean not null default false,
  direct_apply   boolean not null default false,
  error_message  text,
  created_at     timestamptz not null default now(),
  checked_at     timestamptz,
  classified_at  timestamptz,
  replied_at     timestamptz
);

create index cv_check_requests_status_idx on cv_check_requests (status);
create index cv_check_requests_created_at_idx on cv_check_requests (created_at desc);
```

### ステータス遷移

```
pending → checking → found → classified → replied
                   → ended → (replied)
                   → error
```

| ステータス | 意味 | 次のアクション |
|-----------|------|--------------|
| `pending` | ワーカー未処理 | ワーカーが取得 |
| `checking` | ワーカーが確認中 | 結果送信待ち |
| `found` | 募集中と判定 | スタッフが分類 |
| `ended` | 募集終了と判定 | 自動LINE送信済み |
| `classified` | スタッフ分類済み | LINE送信待ち |
| `replied` | LINE返信完了 | 終了 |
| `error` | エラー発生 | 手動確認 |

### 分類タイプ (Classification)

| 値 | 意味 | ユーザーへの案内 |
|----|------|----------------|
| `senkou_moushikomi` | 先行申込 | 内見前に申込でお部屋確保 |
| `senkou_keiyaku` | 先行契約 | 内見なし契約で早く確保 |
| `naiken_ok` | 内見可 | 内見日時の候補を聞く |

---

## 4. APIエンドポイント詳細

### 4-1. POST /api/cv（ユーザーのCV送信）

**認証**: なし（ユーザーのフロント操作）

**リクエスト**:
```json
{
  "propertyId": 12345,
  "type": "availability",
  "agreed": true,
  "directApply": false,
  "lineUserId": "U1234567890abcdef"
}
```

**処理フロー**:
1. 物件情報をDBから取得
2. `cv_check_requests` に `status=pending` で挿入
3. LINEに物件カード + 「確認中です」メッセージをPush送信
4. CRMメッセージログに記録

**フィーチャーフラグ**: `CV_CHECK_ENABLED=true` で自動確認フロー有効

**レスポンス**:
```json
{
  "data": {
    "propertyId": 12345,
    "action": "空室確認",
    "cvCheckRequestId": 1,
    "pushSent": true,
    "autoCheck": true,
    "supportMessage": "物件の最新状況を自動確認中です。結果はLINEでお知らせします。"
  }
}
```

### 4-2. GET /api/cv-check/pending（ワーカーポーリング）

**認証**: `x-api-key` ヘッダー（`CV_WORKER_API_KEY` 環境変数と一致）

**処理**:
1. `status=pending` のリクエストを最大50件取得
2. 取得したリクエストを `status=checking` に更新（二重処理防止）
3. レスポンスで返す

**レスポンス**:
```json
{
  "data": [
    {
      "id": 1,
      "propertyName": "メゾン東京 101",
      "detailUrl": "https://itandibb.com/...",
      "source": "itanji",
      "cvType": "availability"
    }
  ]
}
```

### 4-3. POST /api/cv-check/result（ワーカー結果送信）

**認証**: `x-api-key` ヘッダー

**リクエスト**:
```json
{
  "requestId": 1,
  "status": "found",
  "checkResult": {
    "status": "found",
    "reason": "募集中と判定",
    "url": "https://...",
    "checked_at": "2025-01-01T12:00:00"
  }
}
```

**自動処理**:
- `ended` → LINE「募集終了」メッセージ送信 → `replied` に更新
- `found` → LINE「募集中です」+ 電話予約CTAフレックスメッセージ送信
- `error` → ステータス更新のみ（手動確認待ち）

### 4-4. POST /api/cv-check/classify（スタッフ分類）

**認証**: CRMセッションCookie

**リクエスト**:
```json
{
  "requestId": 1,
  "classification": "naiken_ok"
}
```

**処理**:
1. DBの `classification` / `classified_by` を更新
2. 分類に応じたLINEメッセージ送信
3. CRMメッセージログに記録
4. `replied` に更新

---

## 5. Pythonワーカー詳細

### ファイル: `scraping/cv_check_worker.py`

### 5-1. 起動と初期化

```python
# Playwright起動 → サイトごとに別コンテキスト（別セッション）でログイン
browser = p.chromium.launch(headless=False)

itanji_context = browser.new_context()    # イタンジBB用
page_itanji = itanji_context.new_page()
login_itanji(page_itanji)

esquare_context = browser.new_context()   # e生活スクエア用
page_esquare = esquare_context.new_page()
login_es_square(page_esquare)
```

**ポイント**: サイトごとにブラウザコンテキストを分離し、Cookieの干渉を防止。

### 5-2. 適応型ポーリング

```python
# 3段階のポーリング間隔
POLL_INTERVAL_ACTIVE = 5   # pendingあり時: 5秒
POLL_INTERVAL_IDLE = 15    # pending 0件時: 15秒
ACTIVE_COOLDOWN = 600      # 10分連続アクティブ → 強制アイドル

while True:
    pending = fetch_pending()
    if pending:
        # アクティブモード（5秒間隔）に切替
        for req in pending:
            status, result, error = check_property(page_itanji, page_esquare, req)
            send_result(req_id, status, result, error)
    else:
        # アイドルモード（15秒間隔）に切替
    time.sleep(sleep_time)
```

### 5-3. 物件確認ロジック（コア判定部分）

```python
def check_property_itanji(page, detail_url):
    page.goto(detail_url, wait_until="load", timeout=30000)
    page.wait_for_timeout(2000)

    page_text = page.inner_text("body")

    # 募集終了パターン（サイトに応じてカスタマイズ）
    ended_patterns = [
        "募集終了",
        "この物件は現在募集していません",
        "掲載終了",
        "申込あり",
        "成約済",
        "取り下げ",
    ]

    for pattern in ended_patterns:
        if pattern in page_text:
            return {"status": "ended", "reason": pattern, ...}

    # 404チェック
    if "404" in page.title() or "見つかりません" in page_text:
        return {"status": "ended", "reason": "404", ...}

    # どのパターンにも該当しない → 募集中
    return {"status": "found", "reason": "募集中と判定", ...}
```

**判定ロジック**: ページのテキスト全体に「終了系キーワード」が含まれるかを検索。
どれにも該当しなければ「募集中」と判定する（ホワイトリストではなくブラックリスト方式）。

### 5-4. ソース判定とページ振り分け

```python
def check_property(page_itanji, page_esquare, req):
    detail_url = req["detailUrl"]
    source = req["source"]

    # URL/sourceからどのサイトか判定
    is_itanji = "itandibb.com" in detail_url or "itanji" in source
    is_esquare = "es-square" in detail_url or "es_square" in source

    if is_itanji:
        return check_property_itanji(page_itanji, detail_url)
    elif is_esquare:
        return check_property_esquare(page_esquare, detail_url)
    else:
        # デフォルトはイタンジで試行
        return check_property_itanji(page_itanji, detail_url)
```

### 5-5. リトライ機構

```python
MAX_RETRIES = 3
RETRY_DELAY = 5  # 秒

for attempt in range(1, MAX_RETRIES + 1):
    try:
        status, result, error = check_property(...)
        send_result(req_id, status, result, error)
        break
    except Exception as e:
        if attempt < MAX_RETRIES:
            time.sleep(RETRY_DELAY)
        else:
            send_result(req_id, "error", {}, str(e))
```

### 5-6. API通信

```python
# ワーカー → サーバー間のAPI認証
headers = {"x-api-key": API_KEY}

# 未処理リクエスト取得
resp = requests.get(f"{API_BASE}/api/cv-check/pending?limit=5", headers=headers)

# 結果送信
resp = requests.post(f"{API_BASE}/api/cv-check/result", json={
    "requestId": req_id,
    "status": "found",
    "checkResult": {...}
}, headers=headers)
```

---

## 6. LINEメッセージテンプレート

### ファイル: `src/lib/server/cvCheckMessages.ts`

| 関数 | タイミング | メッセージ例 |
|------|----------|-------------|
| `buildCheckingMessage()` | CV送信直後 | ✅ 空室確認を受け付けました！...確認でき次第ご連絡いたします |
| `buildEndedMessage()` | 募集終了判定時 | ❌ 申し訳ございません。募集が終了しております |
| `buildFoundMessage()` | 募集中判定時 | ✅ こちらの物件は現在募集中です！...追って確認のうえご連絡 |
| `buildClassifiedMessage()` | スタッフ分類後 | 分類に応じた詳細案内（先行申込/先行契約/内見可） |

---

## 7. CRM管理画面

### ファイル: `src/app/crm/(protected)/cv-check/page.tsx`

- ステータス別タブフィルター（All / Found / Pending / Checking / ...）
- 30秒ごとの自動リフレッシュ
- 「found」ステータスの物件にワンクリック分類ボタン（先行申込/先行契約/内見可）
- 各リクエストの物件名・URL・タイムスタンプ・エラーメッセージ表示

---

## 8. 環境変数一覧

```bash
# フィーチャーフラグ（Next.js側）
CV_CHECK_ENABLED=true

# ワーカー認証（Next.js側 + Python側 共通）
CV_WORKER_API_KEY=your-secret-api-key

# ワーカー設定（Python側）
CV_CHECK_API_BASE=https://your-app.vercel.app
CV_POLL_INTERVAL_ACTIVE=5
CV_POLL_INTERVAL_IDLE=15

# 物件サイトログイン情報（Python側）
ITANJI_EMAIL=...
ITANJI_PASSWORD=...
ES_SQUARE_EMAIL=...
ES_SQUARE_PASSWORD=...

# データベース（Next.js側）
DATABASE_URL=postgres://...

# LINE（Next.js側）
LINE_CHANNEL_ACCESS_TOKEN=...
```

---

## 9. 別プロジェクトへの移植チェックリスト

1. **DBテーブル作成**: `cv_check_requests` テーブルを作成（スキーマは自動作成対応）
2. **APIエンドポイント**: 4本作成（cv送信, pending取得, result送信, classify）
3. **認証**: ワーカー用APIキー認証（`x-api-key` ヘッダー）
4. **Pythonワーカー**: Playwright + ポーリングループ
   - 対象サイトごとの `ended_patterns` を定義
   - サイトごとにログイン済みブラウザコンテキストを用意
5. **メッセージ送信**: LINE / Slack / メール等に置き換え可能
6. **CRM管理画面**: ステータス一覧 + 分類ボタン
7. **環境変数**: APIキー、DB接続、サイトログイン情報

### 移植時のカスタマイズポイント

- **`ended_patterns`**: サイトごとの「募集終了」テキストパターンを変更
- **`Classification`**: 分類タイプを業務に合わせて変更
- **メッセージテンプレート**: 通知先やメッセージ文面を変更
- **ポーリング間隔**: 対象リクエスト数やサイト負荷に応じて調整
- **ソース判定**: `check_property()` のURL/source分岐を対象サイトに合わせる

---

## 10. セキュリティ考慮

- ワーカーAPIは `x-api-key` ヘッダーで認証（環境変数で管理）
- CRM操作はセッションCookie認証
- DBの `is_test` フラグでテストリクエストを分離
- `checking` ステータスで二重処理を防止（楽観的ロック）
